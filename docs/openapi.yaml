openapi: 3.0.0
info:
  version: 0.5.0
  title: MX HTTP Proxy API
  description: |
    Выполнение команд через REST API на сервере [Zultys MX](https://www.zultys.com/zultys-cloud-services/).
    Для отслеживания событий на сервере Zultys MX используются [Server-Sent Events API](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events).

    # Errors
    Для возврата кода ошибки используются стандартные коды возврата HTTP:

    | Код   | Описание                                          |
    |-------|---------------------------------------------------|
    | `400` | ошибка разбора параметров запроса                 |
    | `401` | требуется токен с сессией                         |
    | `403` | сессия больше не действительна                    |
    | `404` | команда не поддерживается                         |
    | `415` | неподдерживаемый тип данных                       |
    | `500` | ошибка сервера MX                                 |
    | `502` | сервер MX недоступен или не отвечает на запросы   |
    | `504` | превышено время ожидания ответа от сервера MX     |

    Описание ошибки отдается в виде ответа:

        {
          "error": "MX response timeout"
        }

    В том случае, когда команда успешно выполнена, но не содержит данных для возврата,
    используется код окончания `204`.
    
  license:
    name: MIT
servers:
  - url: /
security:
  - SessionToken: []

paths:
  /login:
    post:
      operationId: login
      tags: [Authorization]
      description: >-
        Осуществляет подключение к серверу MX и авторизует пользователя.
        В ответ возвращается информация об авторизованном пользователе и токен авторизации сессии,
        который необходимо использовать в заголовке авторизации во всех остальных запросах.
      security: []
      requestBody:
        description: параметры для авторизации пользователя на сервер MX
        required: true
        content:
          application/json:
            schema:
              type: object
              description: информация для авторизации соединения
              required:
                - login
                - password
              properties:
                login:
                  type: string
                  description: логин пользователя
                password:
                  type: string
                  format: password
                  description: пароль для авторизации
                type:
                  type: string
                  enum: [User, Server]
                  description: тип авторизации
                platform:
                  type: string
                  example: iPhone
                  description: название платформы
                version:
                  type: string
                  example: '7.0'
                  description: версия платформы
                clientType:
                  type: string
                  enum: [Mobile, Desktop, CRM]
                  description: тип клиента
                serverType:
                  type: string
                  enum: [SMS]
                  description: тип сервера
                loginCapab:
                  type: string
                  example: Audio|Video|Im|911Support|BinIm|WebChat
                  description: дополнительные параметры авторизации
                mediaCapab:
                  type: string
                  example: Voicemail|Fax|CallRec
                  description: дополнительные параметры поддержки данных
                abNotify:
                  type: boolean
                  description: уведомлять об изменении адресной книги
                forced:
                  type: boolean
                  description: завершить все другие сессии данного пользователя
                apiVersion:
                  type: integer
                  format: int32
                  description: поддерживаемая версия MX API
                  example: 11
              example:
                login: mxtest
                password: mx_password
                type: User
                platform: iPhone
                version: '7.0'
      responses:
        '200':
          description: возвращает токен сессии и информацию об авторизованном пользователе
          content:
            application/json:
              schema:
                type: object
                required: [token, api, mx]
                properties:
                  token:
                    type: string
                    description: токен с сессией
                    example: yGuVWEnStvR3kC8P
                  user:
                    type: string
                    description: уникальный идентификатор пользователя MX
                    example: '43892780091502529'
                  device:
                    type: string
                    description: внутренний номер пользователя MX
                    example: '271'
                  softPhonePwd:
                    type: string
                    description: пароль для авторизации SIP
                    example: Pf3Hs4lLcWRpkYRK4MMbBQ1ZF1gI0WDX
                  api:
                    type: integer
                    format: int32
                    description: серверная версия MX API
                    example: 11
                  mx:
                    type: string
                    description: уникальный идентификатор MX
                    example: 631HC
                  maxMsgFileSizeMb:
                    type: integer
                    format: int32
                    description: максимально допустимый размер сообщения в мегабайтах
                  capab:
                    type: string
                    description: поддерживаемые дополнительные опции сервера
                example:
                  token: PGg_bXw8TdBKpSVX
                  sn: 631HC
                  apiVersion: 12
                  ext: '273'
                  jid: '43892780322813134'
                  softPhonePwd: lefIQ43upsZ4dSJ9saGzA5rkAcF2WBJl
        default:
          $ref: '#/components/responses/error'
  /logout:
    post:
      operationId: logout
      tags: [Authorization]
      description: >-
        Завершает сессию и отключается от сервера MX. Авторизационный токен после 
        этого становится недействительным.
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'

  /monitorStart:
    post:
      operationId: monitorStart
      tags: [Events]
      description: >-
        Запуск серверного монитора позволяет отслеживать события о звонках.
        Так же без запущенного монитора недоступны многие операции. Например,
        работа с голосовой почтой.
      requestBody:
        description: параметры для запуска монитора
        content:
          application/json:
            schema:
              type: object
              description: параметры запуска монитора
              required: [device]
              properties:
                device:
                  type: string
                  description: идентификатор устройства
                conf:
                  type: boolean
                  description: отслеживать события конференции
              example:
                device: '199'
      responses:
        '200':
          description: возвращает информацию о запущенном мониторе
          content:
            application/json:
              schema:
                type: object
                description: информация о запущенном мониторе
                required: [monitor]
                properties:
                  monitor:
                    type: integer
                    format: int32
                    description: идентификатор монитора
                example:
                  monitor: 1
        default:
          $ref: '#/components/responses/error'
  /monitorStop:
    post:
      operationId: monitorStop
      tags: [Events]
      description: Останавливает ранее запущенный серверный монитор
      requestBody:
        description: параметры для остановки монитора
        required: true
        content:
            application/json:
              schema:
                type: object
                description: параметры для остановки ранее запущенного монитора
                required: [monitor]
                properties:
                  monitor:
                    type: integer
                    format: int32
                    description: идентификатор монитора
                example:
                  monitor: 1
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /monitorStartAb:
    post:
      operationId: monitorStartAb
      tags: [Events]
      description: Запускает мониторинг изменений адресной книги
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /monitorStopAb:
    post:
      operationId: monitorStopAb
      tags: [Events]
      description: Останавливает мониторинг изменений адресной книги
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'

  /events:
    post:
      operationId: events
      tags: [Events]
      description: | 
        Отдает информацию о серверных событиях в формате 
        [Server-Sent Events](//developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events).
      responses:
        '200':
          description: возвращает информацию о серверных событиях
          content:
            text/event-stream:
              schema:
                anyOf:
                  - title: presence
                    type: object
                    description: presence
                    properties:
                      user:
                        type: string
                        description: from
                      status:
                        type: string
                        description: mxStatus
                      presence:
                        type: string
                        description: presence
                      note:
                        type: string
                        description: presenceNote
                    example:
                      user: '44007001373183196'
                      presence: Available
                      status: USER_HAS_RINGING_CALL|USER_ON_CALL_NO_MORE_LINES
                      note: sample
                  - title: message
                    type: object
                    description: messageHist & message
                    required: [id, from, to]
                    properties:
                      id:
                        type: integer
                        format: int32
                        description: msgId
                      gid:
                        type: integer
                        description: persistId
                      new:
                        type: boolean
                        description: флаг, что сообщение не из истории
                        default: true
                      from:
                        type: string
                        description: from
                        example: '43892780838802510'
                      fromName:
                        type: string
                        description: name
                      to:
                        type: string
                        description: toRecipId
                        example: '43892780838802510'
                      toName:
                        type: string
                        description: toRecipName
                      group:
                        type: string
                        description: groupId
                        example: '43892780838802510'
                      did:
                        type: string
                        description: did
                      req:
                        type: integer
                        description: reqId
                      delivered:
                        type: boolean
                        description: delivered
                      seen:
                        type: boolean
                        description: seen
                      recipType:
                        type: string
                        description: recipType
                        enum: [User, Server, Group]
                      type:
                        type: string
                        description: packetType
                        enum: [Text, Binary, Conf]
                      timestamp:
                        type: integer
                        format: date-time
                        description: timestamp
                      finished:
                        type: boolean
                        description: finished
                      contentState:
                        type: string
                        description: contentState
                      contentSize:
                        type: integer
                        format: int32
                        description: contentSize
                  - title: messageHist
                    type: object
                    description: messageHist & message
                    required: [id, from, to]
                    properties:
                      id:
                        type: integer
                        format: int32
                        description: msgId
                      gid:
                        type: integer
                        description: persistId
                      new:
                        type: boolean
                        description: флаг, что сообщение не из истории
                        default: false
                      from:
                        type: string
                        description: from
                        example: '43892780838802510'
                      fromName:
                        type: string
                        description: name
                      to:
                        type: string
                        description: toRecipId
                        example: '43892780838802510'
                      toName:
                        type: string
                        description: toRecipName
                      group:
                        type: string
                        description: groupId
                        example: '43892780838802510'
                      did:
                        type: string
                        description: did
                      req:
                        type: integer
                        description: reqId
                      delivered:
                        type: boolean
                        description: delivered
                      seen:
                        type: boolean
                        description: seen
                      recipType:
                        type: string
                        description: recipType
                        enum: [User, Server, Group]
                      type:
                        type: string
                        description: packetType
                        enum: [Text, Binary, Conf]
                      timestamp:
                        type: integer
                        format: date-time
                        description: timestamp
                      finished:
                        type: boolean
                        description: finished
                      contentState:
                        type: string
                        description: contentState
                      contentSize:
                        type: integer
                        format: int32
                        description: contentSize
                  - title: DivertedEvent
                    type: object
                    description: >-
                      DivertedEvent indicates that a call has been diverted from a
                      device and that the call is no longer present at the device.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      diverting:
                        type: string
                        description: divertingDevice>deviceIdentifier
                      to:
                        type: string
                        description: newDestination>deviceIdentifier
                      cause:
                        type: string
                        description: cause
                      allowed:
                        type: integer
                        format: int32
                        description: cmdsAllowed
                      flags:
                        type: integer
                        description: callTypeFlags
                    example:
                      monitor: 1
                      call:
                        id: 351
                        device: '199'
                      diverting: '199'
                      to: '199'
                      cause: normal
                      allowed: 272
                      flags: 137363459
                  - title: DeliveredEvent
                    type: object
                    description: >-
                        DeliveredEvent indicates that a call is being presented
                        to a device in either the Ringing or Entering distribution
                        modes of the alerting state.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      alerting:
                        type: string
                        description: alertingDevice>deviceIdentifier
                      alertingName:
                        type: string
                        description: alertingDisplayName
                      networkCalling:
                        type: string
                        description: networkCallingDevice>deviceIdentifier
                      calling:
                        type: string
                        description: callingDevice>deviceIdentifier
                      callingName:
                        type: string
                        description: callingDisplayName
                      called:
                        type: string
                        description: calledDevice>deviceIdentifier
                      lastRedirection:
                        type: string
                        description: lastRedirectionDevice>deviceIdentifier
                      localConnection:
                        type: string
                        description: localConnectionInfo
                      cause:
                        type: string
                        description: cause
                      allowed:
                        type: integer
                        format: int32
                        description: cmdsAllowed
                      flags:
                        type: integer
                        format: int32
                        description: callTypeFlags
                      cads:
                        type: array
                        items:
                          $ref: '#/components/schemas/cad'
                    example:
                      monitor: 1
                      call:
                        id: 351
                        device: '199'
                        global: '2809269720623105293'
                      alerting: '*86'
                      alertingName: voicemail
                      networkCalling: Vasily Znamensky
                      calling: '192'
                      callingName: Vasily Znamensky
                      called: '*86'
                      lastRedirection: ''
                      localConnection: alerting
                      cause: normal
                      flags: 3145736
                      cads:
                        - name: __FIRST_CALL_ID__
                          type: string
                          value: 631UN-B5-00004-50E
                  - title: EstablishedEvent
                    type: object
                    description: >-
                      EstablishedEvent indicates that a call has been answered
                      at a device or that a call has been connected to a device.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      answering:
                        type: string
                        description: answeringDevice>deviceIdentifier
                      answeringName:
                        type: string
                        description: answeringDisplayName
                      calling:
                        type: string
                        description: callingDevice>deviceIdentifier
                      callingName:
                        type: string
                        description: callingDisplayName
                      called:
                        type: string
                        description: calledDevice>deviceIdentifier
                      lastRedirection:
                        type: string
                        description: lastRedirectionDevice>deviceIdentifier
                      cause:
                        type: string
                        description: cause
                      allowed:
                        type: integer
                        format: int32
                        description: cmdsAllowed
                      flags:
                        type: integer
                        format: int32
                        description: callTypeFlags
                      cads:
                        type: array
                        items:
                          $ref: '#/components/schemas/cad'
                    example:
                      monitor: 1
                      call:
                        id: 5
                        device: '199'
                        global: '2809269720623105284'
                      answering: '199'
                      answeringName: Maxim Donchenko
                      calling: '192'
                      callingName: Vasily Znamensky
                      called: '*86'
                      calledName: voicemail
                      lastRedirection: ''
                      cause: normal
                      flags: 137371651
                      cads:
                        - name: __FIRST_CALL_ID__
                          type: string
                          value: 631UN-B5-00004-504
                  - title: HeldEvent
                    type: object
                    description: HeldEvent indicates that a call has been placed on hold.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      holding:
                        type: string
                        description: holdingDevice>deviceIdentifier
                      localConnection:
                        type: string
                        description: localConnectionInfo
                      cause:
                        type: string
                        description: cause
                      allowed:
                        type: integer
                        format: int32
                        description: cmdsAllowed
                      flags:
                        type: integer
                        format: int32
                        description: callTypeFlags
                    example:
                      monitor: 1
                      call:
                        id: 56
                        device: '199'
                      holding: '199'
                      cause: normal
                      allowed: 376
                      flags: 141565955
                  - title: RecordingStateEvent
                    type: object
                    description: RecordingStateEvent
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      available:
                        type: boolean
                        description: RecIsAvailable
                      active:
                        type: boolean
                        description: RecIsActive
                    example:
                      monitor: 1
                      call:
                        id: 18
                        device: '199'
                      available: true
                      active: false
                  - title: ServiceInitiatedEvent
                    type: object
                    description: >-
                      ServiceInitiatedEvent indicates that a telephony service has been
                      initiated at a monitored device.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      initiating:
                        type: string
                        description: initiatingDevice>deviceIdentifier
                      localConnection:
                        type: string
                        description: localConnectionInfo
                      cause:
                        type: string
                        description: cause
                    example:
                      monitor: 1
                      call:
                        id: 56
                        device: '199'
                      localConnection: initializing
                      initiating: '199'
                      cause: normal
                  - title: ConnectionClearedEvent
                    type: object
                    description: >-
                      ConnectionClearedEvent indicates that a call has been cleared and no
                      longer exists.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      releasing:
                        type: string
                        description: releasingDevice>deviceIdentifier
                      cause:
                        type: string
                        description: cause
                    example:
                      monitor: 1
                      call:
                        id: 56
                        device: '199'
                      releasing: '199'
                      cause: normal
                  - title: OriginatedEvent
                    type: object
                    description: >-
                      OriginatedEvent indicates that a call is being attempted
                      from a device.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      calling:
                        type: string
                        description: callingDevice>deviceIdentifier
                      called:
                        type: string
                        description: calledDevice>deviceIdentifier
                      localConnection:
                        type: string
                        description: localConnectionInfo
                      cause:
                        type: string
                        description: cause
                      allowed:
                        type: integer
                        format: int32
                        description: cmdsAllowed
                      flags:
                        type: integer
                        format: int32
                        description: callTypeFlags
                    example:
                      monitor: 1
                      call:
                        id: 56
                        device: '199'
                      calling: '199'
                      called: '192'
                      cause: normal
                      flags: 3145728
                  - title: NetworkReachedEvent
                    type: object
                    description: >- 
                      NetworkReachedEvent indicates that a call has cut
                      through the switching sub-domain boundary to another network.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      network:
                        type: string
                        description: networkInterfaceUsed>deviceIdentifier
                      calling:
                        type: string
                        description: callingDevice>deviceIdentifier
                      called:
                        type: string
                        description: calledDevice>deviceIdentifier
                      localConnection:
                        type: string
                        description: localConnectionInfo
                      cause:
                        type: string
                        description: cause
                    example:
                      monitor: 1
                      call:
                        id: 56
                        device: '199'
                      network: '190'
                      calling: '199'
                      called: '192'
                      cause: normal
                  - title: FailedEvent
                    type: object
                    description: >- 
                      FailedEvent indicates that a call cannot be completed or a
                      connection has entered the Failed state.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      calling:
                        type: string
                        description: callingDevice>deviceIdentifier
                      called:
                        type: string
                        description: calledDevice>deviceIdentifier
                      localConnection:
                        type: string
                        description: localConnectionInfo
                      cause:
                        type: string
                        description: cause
                    example:
                      monitor: 1
                      call:
                        id: 56
                        device: '199'
                      calling: '199'
                      called: '192'
                      localConnection: ''
                      cause: normal
                  - title: RetrievedEvent
                    type: object
                    description: >- 
                      RetrievedEvent indicates that a previously held call has been
                      retrieved.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      retrieving:
                        type: string
                        description: retrievingDevice>deviceIdentifier
                      localConnection:
                        type: string
                        description: localConnectionInfo
                      cause:
                        type: string
                        description: cause
                      allowed:
                        type: integer
                        format: int32
                        description: cmdsAllowed
                      flags:
                        type: integer
                        format: int32
                        description: callTypeFlags
                    example:
                      monitor: 1
                      call:
                        id: 56
                        device: '199'
                      retrieving: '199'
                      localConnection: ''
                      cause: normal
                      flags: 3145728
                  - title: TransferredEvent # в xml название события с ошибкой: одна буква r
                    type: object
                    description: >-
                      TransferedEvent indicates that an existing call has been
                      transferred to another device and the transferring device has
                      been dropped from the call.
                    required: [monitor, call]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      call:
                        $ref: '#/components/schemas/callInfo'
                      transferring:
                        type: string
                        description: transferringDevice>deviceIdentifier
                      to:
                        type: string
                        description: transferredToDevice>deviceIdentifier
                      localConnection:
                        type: string
                        description: localConnectionInfo
                      cause:
                        type: string
                        description: cause
                    example:
                      monitor: 1
                      call:
                        id: 56
                        device: '199'
                      transferring: '199'
                      to: '198'
                      localConnection: ''
                      cause: normal
                      flags: 3145728
                  - title: ParkedEvent
                    type: object
                    description: callParkInfo
                    required: [monitor, park]
                    properties:
                      monitor:
                        type: integer
                        format: int32
                        description: monitorCrossRefID
                      park: 
                        type: integer
                        format: int32
                        description: parkID
                    example:
                      monitor: 1
                      park: 3
                  - title: callloginfo
                    type: array
                    description: callloginfo
                    items:
                      type: object
                      required: [id]
                      properties:
                        id:
                          type: integer
                          description: record_id
                        missed:
                          type: boolean
                          description: missed
                        direction:
                          type: string
                          description: direction
                        gcid:
                          type: string
                          description: gcid
                        connectTimestamp:
                          type: integer
                          format: date-time
                          description: connectTimestamp
                        disconnectTimestamp:
                          type: integer
                          format: date-time
                          description: disconnectTimestamp
                        callingPartyNo:
                          type: string
                          description: callingPartyNo
                        originalCalledPartyNo:
                          type: string
                          description: originalCalledPartyNo
                        firstName:
                          type: string
                          description: firstName
                        lastName:
                          type: string
                          description: lastName
                        device:
                          type: string
                          description: extension
                        serviceName:
                          type: string
                          description: serviceName
                        serviceExtension:
                          type: string
                          description: serviceExtension
                        callType:
                          type: integer
                          format: int32
                          description: callType
                        legType:
                          type: integer
                          format: int32
                          description: legType
                        selfLegType:
                          type: integer
                          format: int32
                          description: selfLegType
                        monitorType:
                          type: integer
                          format: int32
                          description: monitorType
              example: |
                  event: presence
                  data: {"presence":"Available","status":"USER_ACCEPTS_IM","note":"Заметка к статусу"}
                      
                  event: ConnectionClearedEvent
                  data: {"monitor":1,"call":{"id":56,"device":"199"},"releasing":"199","cause":"normal"}
        default:
          $ref: '#/components/responses/error'

  /makeCall:
    post:
      operationId: makeCall
      tags: [Calls]
      description: Запускает дозвон на указанный номер или устройство
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [to]
              properties:
                device:
                  type: string
                  description: идентификатор устройства
                  example: '234'
                to:
                  type: string
                  description: телефонный номер или идентификатор устройства
                  example: '79031744445'
                group:
                  type: string
                  description: идентификатор группы
                callerId:
                  type: string
                  description: идентификатор пользователя
                callerName:
                  type: string
                  description: имя пользователя
              example:
                device: '243'
                to: '79031744445'
      responses:
        '200':
          description: возвращает идентификатор звонка
          content:
            application/json:
              schema:
                type: object
                required: [call]
                properties:
                  call:
                    $ref: '#/components/schemas/call'
                  calledDevice:
                    type: string
                    description: идентификатор устройства
        default:
          $ref: '#/components/responses/error'
  /clearConnection:
    post:
      operationId: clearConnection
      tags: [Calls]
      description: Отменяет или завершает звонок
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [call]
              properties:
                call: 
                  $ref: '#/components/schemas/call'
              example:
                call:
                  id: 18
                  device: '203'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /answerCall:
    post:
      operationId: answerCall
      tags: [Calls]
      description: Принимает входящий звонок
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [call]
              properties:
                call: 
                  $ref: '#/components/schemas/call'
              example:
                call:
                  id: 18
                  device: '203'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /holdCall:
    post:
      operationId: holdCall
      tags: [Calls]
      description: Временно ставит звонок на паузу
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [call, to]
              properties:
                call: 
                  $ref: '#/components/schemas/call'
              example:
                call:
                  id: 18
                  device: '203'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /parkCall:
    post:
      operationId: parkCall
      tags: [Calls]
      description: Откладывает текущий звонок для дальнейшей передачи его на другое устройство
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [call, to]
              properties:
                call: 
                  $ref: '#/components/schemas/call'
              example:
                call:
                  id: 18
                  device: '203'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /retriveCall:
    post:
      operationId: retriveCall
      tags: [Calls]
      description: Восстанавливает отложенный или поставленный на паузу звонок
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [call, to]
              properties:
                call: 
                  $ref: '#/components/schemas/call'
              example:
                call:
                  id: 18
                  device: '203'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /singleStepTranferCall:
    post:
      operationId: singleStepTranferCall
      tags: [Calls]
      description: Перенаправляет звонок на другое устройство
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [call, to]
              properties:
                call: 
                  $ref: '#/components/schemas/call'
                to:
                  type: string
                  description: номер телефона или идентификатор устройства
              example:
                call:
                  id: 18
                  device: '203'
                to: '79031744445'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /deflectCall:
    post:
      operationId: deflectCall
      tags: [Calls]
      description: Перенаправляет звонок на другой номер или устройство
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [call, to]
              properties:
                call: 
                  $ref: '#/components/schemas/call'
                to:
                  type: string
                  description: идентификатор устройства
              example:
                call:
                  id: 18
                  device: '203'
                to: '204'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /transferCall:
    post:
      operationId: transferCall
      tags: [Calls]
      description: >-
        Объединяет два звонка (активный и на паузе), соединяя абонентов друг с другом и 
        исключая текущего пользователя.
      requestBody:
        description: параметры звонков
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [heldCall, activeCall]
              properties:
                heldCall: 
                  $ref: '#/components/schemas/call'
                activeCall:
                  $ref: '#/components/schemas/call'
              example:
                heldCall:
                  id: 18
                  device: '203'
                activeCall:
                  id: 19
                  device: '204'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /getCallLog:
    post:
      operationId: getCallLog
      tags: [Calls]
      description: Запрашивает получение лога звонков. Сам лог возвращается в виде событий `callloginfo`.
      requestBody:
        description: параметры запроса
        content:
          application/json:
            schema:
              type: object
              properties:
                timestamp:
                  type: integer
                  default: -1
                  description: возвращать только записи старше указанного времени
                  example: 1532848385
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /assignDevice:
    post:
      operationId: assignDevice
      tags: [Calls]
      description: Назначает новое устройство пользователя
      requestBody:
        description: параметры запроса
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                device:
                  type: object
                  description: описание устройства
                  required: [name]
                  properties:
                    name:
                      type: string
                      description: имя устройства
                      example: dm
                    type:
                      type: string
                      description: тип устройства
                      example: address
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /setCallMode:
    post:
      operationId: setCallMode
      tags: [Calls]
      description: Изменяет режим звонка
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mode:
                  type: string
                  enum: [local, remote]
                  default: local
                  description: режим устройства
                  example: remote
                ringDelay:
                  type: integer
                  format: int32
                  default: 20
                  description: задержка перед звонком
                vmDelay:
                  type: integer
                  format: int32
                  default: 10
                  description: задержка перед переходом на голосовую почту
                device:
                  type: string
                  description: имя устройства
                  example: dm
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /startRecording:
    post:
      operationId: startRecording
      tags: [Calls]
      description: Запускает запись звонка
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [call]
              properties:
                call: 
                  $ref: '#/components/schemas/call'
                group:
                  type: string
                  description: идентификатор группы
              example:
                call:
                  id: 18
                  device: '203'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /stopRecording:
    post:
      operationId: stopRecording
      tags: [Calls]
      description: Останавливает запись звонка
      requestBody:
        description: параметры звонка
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [call]
              properties:
                call: 
                  $ref: '#/components/schemas/call'
                group:
                  type: string
                  description: идентификатор группы
              example:
                call:
                  id: 18
                  device: '203'
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'

  /vmGetList:
    post:
      operationId: vmGetList
      tags: [VoiceMail]
      description: Получение списка голосовых сообщений
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                user:
                  type: string
                  description: уникальный идентификатор пользователя
                  example: '43892780322813134'
                mediaType:
                  type: string
                  description: тип данных
                  enum: [VoiceMail, Recording, Fax, Undefined]
                  default: VoiceMail
      responses:
        '200':
          description: список файлов с голосовой почтой или записыми звонков
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required: [id, from, to, received]
                  properties:
                    id:
                      type: integer
                      description: уникальный идентификатор
                    from:
                      type: string
                      description: от кого
                    fromName:
                      type: string
                      description: имя отправителя
                    callerName:
                      type: string
                      description: отправитель
                    to:
                      type: string
                      description: кому
                    ownerType:
                      type: string
                      description: тип владельца
                    mediaType:
                      type: string
                      enum: [VoiceMail, Recording, Fax, Undefined]
                      default: VoiceMail
                      description: тип данных
                    received:
                      type: integer
                      format: date-time
                      description: дата и время приема
                    duration:
                      type: integer
                      format: int32
                      description: длительность
                    read:
                      type: boolean
                      description: флаг прочитанности
                    note:
                      type: string
                      description: текст заметки
                example:
                  - id: 1656
                    from: '272'
                    fromName": 'first last'
                    callerName: '272'
                    to: '273'
                    ownerType: user
                    received: 1532833620
                    duration: 8
                  - id: 1657
                    from: '271'
                    fromName": 'Test User'
                    callerName: '271'
                    to: '273'
                    ownerType: user
                    received: 1532840804
                    duration: 1200
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /vmDelete:
    post:
      operationId: vmDelete
      tags: [VoiceMail]
      description: Удаление голосового сообщения
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                user:
                  type: string
                  description: уникальный идентификатор пользователя
                  example: '43892780322813134'
                id:
                  type: integer
                  format: int32
                  description: идентификатор голосового сообщения
                  example: 128
                mediaType:
                  type: string
                  description: тип данных
                  enum: [VoiceMail, Recording, Fax, Undefined]
                  default: VoiceMail

      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /vmSetStatus:
    post:
      operationId: vmSetStatus
      tags: [VoiceMail]
      description: Изменение флага прочитанности
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                user:
                  type: string
                  description: уникальный идентификатор пользователя
                  example: '43892780322813134'
                id:
                  type: integer
                  description: идентификатор голосового сообщения
                  example: 128
                mediaType:
                  type: string
                  description: тип данных
                  enum: [VoiceMail, Recording, Fax, Undefined]
                  default: VoiceMail
                read:
                  type: boolean
                  description: флаг прочитанности
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /vmUpdateNote:
    post:
      operationId: vmUpdateNote
      tags: [VoiceMail]
      description: Изменение текста заметки голосового сообщения
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: integer
                  format: int32
                  description: идентификатор голосового сообщения
                  example: 128
                mediaType:
                  type: string
                  description: тип данных
                  enum: [VoiceMail, Recording, Fax, Undefined]
                  default: VoiceMail
                note:
                  type: string
                  description: текст заметки
      responses:
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /vmReceive:
    post:
      operationId: vmReceive
      tags: [VoiceMail]
      description: Получение файла с голосовой почтой
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: integer
                  format: int32
                  description: идентификатор голосового сообщения
                  example: 128
                mediaType:
                  type: string
                  description: тип данных
                  enum: [VoiceMail, Recording, Fax, Undefined]
                  default: VoiceMail
      responses:
        '200':
          description: файл с голосовой почтой
          content:
            audio/wave:
              schema:
                type: string
                format: binary
                description: содержимое файла
        default:
          $ref: '#/components/responses/error'

  /getAddressBook:
    post:
      operationId: getAddressBook
      tags: [Services]
      description: Отдает информацию о контактах, зарегистрированных на сервере MX
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                sort:
                  type: string
                  enum: [last, first]
                  default: last
                  description: режим сортировки контактов (по фамилии или имени)
      responses:
        '200':
          description: список контаков
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required: [id, device]
                  properties:
                    id:
                      type: string
                      description: уникальный идентификатор
                    device:
                      type: string
                      description: внутренний телефон (устройство)
                    firstName:
                      type: string
                      description: имя
                    lastName:
                      type: string
                      description: фамилия
                    homePhone:
                      type: string
                      description: номер домашнего телефона
                    cellPhone:
                      type: string
                      description: номер мобильного телефона
                    email:
                      type: string
                      format: email
                      description: email
                    homeSystem:
                      type: string
                      description: уникальный идентификатор [???]
                    did:
                      type: string
                      description: '[???]'
                    exchangeId:
                      type: string
                      description: идентификатор пользователя в MS Exchange
                example:
                  - jid: '43892780838802510'
                    device: '296'
                    firstName: Test
                    lastName: Apple
                  - jid: '43892780541311342'
                    device: '299'
                    firstName: Maxim
                    lastName: Donchenko
                    cellPhone: '+37256847584'
                    email: maximd@xyzrd.com
                  - jid: '43892780722835390'
                    device: '295'
                    firstName: Muhammet
                    lastName: Madraimov
                  - jid: '43892780920507627'
                    device: '294'
                    firstName: Dmitry
                    lastName: Sedykh
                    cellPhone: '+79031744445'
                    email: dmitrys@xyzrd.com
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'
  /getServiceList:
    post:
      operationId: getServiceList
      tags: [Services]
      description: Получение списка настроек сервисов
      responses:
        '200':
          description: список настроек сервисов
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required: [id, name, type, device]
                  properties:
                    id:
                      type: string
                      description: уникальный идентификатор
                    name:
                      type: string
                      description: название сервиса
                    type:
                      type: string
                      description: тип
                    device:
                      type: string
                      description: идентификатор устройства
                    homeSystem:
                      type: string
                      description: '[???]'
                example:
                  - id: '3458764514634960449'
                    name: park
                    type: ParkServer
                    device: '*77'
                  - id: '3502657293077671189'
                    name: Default
                    type: AA
                    device: '201'
                  - id: '3458764515733933107'
                    name: bind
                    type: BindServer
                    device: '*27'
                  - id: '3458764514472757356'
                    name: voicemail
                    type: VM
                    device: '*86'
                  - id: '3502657293164177462'
                    name: WaitFor
                    type: AA
                    device: '204'
        '204':
          $ref: '#/components/responses/204'
        default:
          $ref: '#/components/responses/error'

tags:
  - name: Authorization
    description: Подключение к MX
  - name: Events
    description: Серверные события и их мониторинг
  - name: Calls
    description: Работа со звонками
  - name: VoiceMail
    description: Голосовые сообщения, записи звонков, факсы
  - name: Services
    description: Работа с сервисами MX

components:
  securitySchemes:
    SessionToken:
      type: http
      scheme: bearer
      description: |
        Токен сессии возвращается при авторизации пользователя ([`/login`](#operation/Login)) 
        и действителен до тех пор, пока сервер поддерживает соединение с MX или не выполнена команда 
        [`/logout`](#operation/Logout). После этого необходимо заново авторизоваться и получать новый токен с 
        идентификатором сесии.

        Данный токен необходимо использовать для все запросов API, кроме непосредственно
        запроса авторизации:

            Authorization: Bearer LRSO4vGDdyLA6UQl

        В качестве альтернативы токен авторизации можно передавать не в заголовке, а
        в виде параметра запроса `?access_token=...`. Данный подход можно использовать,
        например, при создании запроса на получение событий сервера MX с помощью 
        [HTTP Server-Sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events).

  schemas:
    call:
      title: call
      type: object
      description: Описывает информацию о звонке
      required: [id, device]
      properties:
        id: 
          type: integer
          format: int32
          description: callID
        device:
          type: string
          description: deviceID
      example:
        id: 18
        device: '234'
    callInfo:
      title: call
      type: object
      description: Описывает информацию о звонке
      required: [id, device]
      properties:
        id: 
          type: integer
          format: int32
          description: callID
        device:
          type: string
          description: deviceID
        global:
          type: string
          description: globalCallID
      example:
        id: 18
        device: '234'
    cad:
      title: cad
      type: object
      required: [name, type, value]
      properties:
        name:
          type: string
          description: name
        type:
          type: string
          description: type
        value:
          type: string
          description: value

  responses:
    '204':
      description: успешное выполнение команды
    error: 
      description: ошибка выполнения команды
      content:
        application/json:
          schema:
            description: формат возвращаемой ошибки
            type: object
            required:
              - error
            properties:
              error:
                type: string
                description: описание ошибки
                example: MX error
